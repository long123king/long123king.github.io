<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<title>do_mmap&#x89E3;&#x8BFB;</title>
<body><div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> do_mmap_pgoff(<span style="color: #0000ff;">struct</span> file *file, <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> addr,</pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span>             <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> len, <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> prot,</pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span>             <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> flags, <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> pgoff)</pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span> {</pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span>     <span style="color: #0000ff;">struct</span> mm_struct * mm = current-&gt;mm;</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span>     <span style="color: #0000ff;">struct</span> inode *inode;</pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span>     vm_flags_t vm_flags;</pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span>     <span style="color: #0000ff;">int</span> error;</pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span>     <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> reqprot = prot;</pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>     <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span> <span style="color: #008000;">     * Does the application expect PROT_READ to imply PROT_EXEC?</span></pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span> <span style="color: #008000;">     *</span></pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span> <span style="color: #008000;">     * (the exception is when the underlying filesystem is noexec</span></pre>
<!--CRLF-->
<pre><span id="lnum15" style="color: #606060;">  15:</span> <span style="color: #008000;">     *  mounted, in which case we dont add PROT_EXEC.)</span></pre>
<!--CRLF-->
<pre><span id="lnum16" style="color: #606060;">  16:</span> <span style="color: #008000;">     */</span></pre>
<!--CRLF-->
<pre><span id="lnum17" style="color: #606060;">  17:</span>     <span style="color: #0000ff;">if</span> ((prot &amp; PROT_READ) &amp;&amp; (current-&gt;personality &amp; READ_IMPLIES_EXEC))</pre>
<!--CRLF-->
<pre><span id="lnum18" style="color: #606060;">  18:</span>         <span style="color: #0000ff;">if</span> (!(file &amp;&amp; (file-&gt;f_path.mnt-&gt;mnt_flags &amp; MNT_NOEXEC)))</pre>
<!--CRLF-->
<pre><span id="lnum19" style="color: #606060;">  19:</span>             prot |= PROT_EXEC;</pre>
<!--CRLF-->
<pre><span id="lnum20" style="color: #606060;">  20:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum21" style="color: #606060;">  21:</span>     <span style="color: #0000ff;">if</span> (!len)</pre>
<!--CRLF-->
<pre><span id="lnum22" style="color: #606060;">  22:</span>         <span style="color: #0000ff;">return</span> -EINVAL;</pre>
<!--CRLF-->
<pre><span id="lnum23" style="color: #606060;">  23:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum24" style="color: #606060;">  24:</span>     <span style="color: #0000ff;">if</span> (!(flags &amp; MAP_FIXED))</pre>
<!--CRLF-->
<pre><span id="lnum25" style="color: #606060;">  25:</span>         addr = round_hint_to_min(addr);</pre>
<!--CRLF--></div>
</div>
<p>1. personality</p>
<blockquote>
<p>Linux has the concept of <em>personality</em> of an executable (since 1.1.20). The purpose is to make the Linux environment more similar to some other environment, like BSD or SCO or Solaris or older Linux, so that foreign or old binaries have better chances of working without modification.</p>
<p><a title="http://blog.chinaunix.net/uid-20357359-id-1963659.html" href="http://blog.chinaunix.net/uid-20357359-id-1963659.html">http://blog.chinaunix.net/uid-20357359-id-1963659.html</a></p>
</blockquote>
<p>2. 如果调用都没有要求MAP_FIXED，即可以由内核来决定将文件映射到哪个内存地址上。</p>
<blockquote>
<p>addr = round_hint_to_min(addr);</p>
<p>&nbsp;</p>
</blockquote>
<p>根据函数的名字，可以猜到它的意图是&ldquo;随机化地设置映射文件的开始地址&rdquo;，以防止恶意程序对代码位置的猜测和利用。</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span> <span style="color: #008000;"> * If a hint addr is less than mmap_min_addr change hint to be as</span></pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span> <span style="color: #008000;"> * low as possible but still greater than mmap_min_addr</span></pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span> <span style="color: #008000;"> */</span></pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">inline</span> <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> round_hint_to_min(<span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> hint)</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span> {</pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span>     hint &amp;= PAGE_MASK;</pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span>     <span style="color: #0000ff;">if</span> (((<span style="color: #0000ff;">void</span> *)hint != NULL) &amp;&amp;</pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span>         (hint &lt; mmap_min_addr))</pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span>         <span style="color: #0000ff;">return</span> PAGE_ALIGN(mmap_min_addr);</pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>     <span style="color: #0000ff;">return</span> hint;</pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span> }</pre>
<!--CRLF--></div>
</div>
<p><span style="color: #ff0000;">不过好像没有做什么？</span></p>
<p>&nbsp;</p>
<p>映射的几种类型</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #0000ff;">if</span> (file) {</pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span>         <span style="color: #0000ff;">switch</span> (flags &amp; MAP_TYPE) {</pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span>         <span style="color: #0000ff;">case</span> MAP_SHARED:</pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span>             <span style="color: #0000ff;">if</span> ((prot&amp;PROT_WRITE) &amp;&amp; !(file-&gt;f_mode&amp;FMODE_WRITE))</pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span>                 <span style="color: #0000ff;">return</span> -EACCES;</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span>             <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span> <span style="color: #008000;">             * Make sure we don't allow writing to an append-only</span></pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span> <span style="color: #008000;">             * file..</span></pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span> <span style="color: #008000;">             */</span></pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>             <span style="color: #0000ff;">if</span> (IS_APPEND(inode) &amp;&amp; (file-&gt;f_mode &amp; FMODE_WRITE))</pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span>                 <span style="color: #0000ff;">return</span> -EACCES;</pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span>             <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum15" style="color: #606060;">  15:</span> <span style="color: #008000;">             * Make sure there are no mandatory locks on the file.</span></pre>
<!--CRLF-->
<pre><span id="lnum16" style="color: #606060;">  16:</span> <span style="color: #008000;">             */</span></pre>
<!--CRLF-->
<pre><span id="lnum17" style="color: #606060;">  17:</span>             <span style="color: #0000ff;">if</span> (locks_verify_locked(inode))</pre>
<!--CRLF-->
<pre><span id="lnum18" style="color: #606060;">  18:</span>                 <span style="color: #0000ff;">return</span> -EAGAIN;</pre>
<!--CRLF-->
<pre><span id="lnum19" style="color: #606060;">  19:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum20" style="color: #606060;">  20:</span>             vm_flags |= VM_SHARED | VM_MAYSHARE;</pre>
<!--CRLF-->
<pre><span id="lnum21" style="color: #606060;">  21:</span>             <span style="color: #0000ff;">if</span> (!(file-&gt;f_mode &amp; FMODE_WRITE))</pre>
<!--CRLF-->
<pre><span id="lnum22" style="color: #606060;">  22:</span>                 vm_flags &amp;= ~(VM_MAYWRITE | VM_SHARED);</pre>
<!--CRLF-->
<pre><span id="lnum23" style="color: #606060;">  23:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum24" style="color: #606060;">  24:</span>             <span style="color: #008000;">/* fall through */</span></pre>
<!--CRLF-->
<pre><span id="lnum25" style="color: #606060;">  25:</span>         <span style="color: #0000ff;">case</span> MAP_PRIVATE:</pre>
<!--CRLF-->
<pre><span id="lnum26" style="color: #606060;">  26:</span>             <span style="color: #0000ff;">if</span> (!(file-&gt;f_mode &amp; FMODE_READ))</pre>
<!--CRLF-->
<pre><span id="lnum27" style="color: #606060;">  27:</span>                 <span style="color: #0000ff;">return</span> -EACCES;</pre>
<!--CRLF-->
<pre><span id="lnum28" style="color: #606060;">  28:</span>             <span style="color: #0000ff;">if</span> (file-&gt;f_path.mnt-&gt;mnt_flags &amp; MNT_NOEXEC) {</pre>
<!--CRLF-->
<pre><span id="lnum29" style="color: #606060;">  29:</span>                 <span style="color: #0000ff;">if</span> (vm_flags &amp; VM_EXEC)</pre>
<!--CRLF-->
<pre><span id="lnum30" style="color: #606060;">  30:</span>                     <span style="color: #0000ff;">return</span> -EPERM;</pre>
<!--CRLF-->
<pre><span id="lnum31" style="color: #606060;">  31:</span>                 vm_flags &amp;= ~VM_MAYEXEC;</pre>
<!--CRLF-->
<pre><span id="lnum32" style="color: #606060;">  32:</span>             }</pre>
<!--CRLF-->
<pre><span id="lnum33" style="color: #606060;">  33:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum34" style="color: #606060;">  34:</span>             <span style="color: #0000ff;">if</span> (!file-&gt;f_op || !file-&gt;f_op-&gt;mmap)</pre>
<!--CRLF-->
<pre><span id="lnum35" style="color: #606060;">  35:</span>                 <span style="color: #0000ff;">return</span> -ENODEV;</pre>
<!--CRLF-->
<pre><span id="lnum36" style="color: #606060;">  36:</span>             <span style="color: #0000ff;">break</span>;</pre>
<!--CRLF-->
<pre><span id="lnum37" style="color: #606060;">  37:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum38" style="color: #606060;">  38:</span>         <span style="color: #0000ff;">default</span>:</pre>
<!--CRLF-->
<pre><span id="lnum39" style="color: #606060;">  39:</span>             <span style="color: #0000ff;">return</span> -EINVAL;</pre>
<!--CRLF-->
<pre><span id="lnum40" style="color: #606060;">  40:</span>         }</pre>
<!--CRLF-->
<pre><span id="lnum41" style="color: #606060;">  41:</span>     } <span style="color: #0000ff;">else</span> {</pre>
<!--CRLF-->
<pre><span id="lnum42" style="color: #606060;">  42:</span>         <span style="color: #0000ff;">switch</span> (flags &amp; MAP_TYPE) {</pre>
<!--CRLF-->
<pre><span id="lnum43" style="color: #606060;">  43:</span>         <span style="color: #0000ff;">case</span> MAP_SHARED:</pre>
<!--CRLF-->
<pre><span id="lnum44" style="color: #606060;">  44:</span>             <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum45" style="color: #606060;">  45:</span> <span style="color: #008000;">             * Ignore pgoff.</span></pre>
<!--CRLF-->
<pre><span id="lnum46" style="color: #606060;">  46:</span> <span style="color: #008000;">             */</span></pre>
<!--CRLF-->
<pre><span id="lnum47" style="color: #606060;">  47:</span>             pgoff = 0;</pre>
<!--CRLF-->
<pre><span id="lnum48" style="color: #606060;">  48:</span>             vm_flags |= VM_SHARED | VM_MAYSHARE;</pre>
<!--CRLF-->
<pre><span id="lnum49" style="color: #606060;">  49:</span>             <span style="color: #0000ff;">break</span>;</pre>
<!--CRLF-->
<pre><span id="lnum50" style="color: #606060;">  50:</span>         <span style="color: #0000ff;">case</span> MAP_PRIVATE:</pre>
<!--CRLF-->
<pre><span id="lnum51" style="color: #606060;">  51:</span>             <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum52" style="color: #606060;">  52:</span> <span style="color: #008000;">             * Set pgoff according to addr for anon_vma.</span></pre>
<!--CRLF-->
<pre><span id="lnum53" style="color: #606060;">  53:</span> <span style="color: #008000;">             */</span></pre>
<!--CRLF-->
<pre><span id="lnum54" style="color: #606060;">  54:</span>             pgoff = addr &gt;&gt; PAGE_SHIFT;</pre>
<!--CRLF-->
<pre><span id="lnum55" style="color: #606060;">  55:</span>             <span style="color: #0000ff;">break</span>;</pre>
<!--CRLF-->
<pre><span id="lnum56" style="color: #606060;">  56:</span>         <span style="color: #0000ff;">default</span>:</pre>
<!--CRLF-->
<pre><span id="lnum57" style="color: #606060;">  57:</span>             <span style="color: #0000ff;">return</span> -EINVAL;</pre>
<!--CRLF-->
<pre><span id="lnum58" style="color: #606060;">  58:</span>         }</pre>
<!--CRLF-->
<pre><span id="lnum59" style="color: #606060;">  59:</span>     }</pre>
<!--CRLF--></div>
</div>
<table style="width: 400px;" border="0" cellspacing="0" cellpadding="2">
<tbody>
<tr>
<td valign="top" width="133">&nbsp;</td>
<td valign="top" width="133">有后备文件</td>
<td valign="top" width="133">无后备文件</td>
</tr>
<tr>
<td valign="top" width="133">共享映射</td>
<td valign="top" width="133"><span style="color: #c0504d;">共享文件映射</span></td>
<td valign="top" width="133"><span style="color: #c0504d;">共享匿名映射</span></td>
</tr>
<tr>
<td valign="top" width="133">私有映射</td>
<td valign="top" width="133"><span style="color: #c0504d;">私有文件映射</span></td>
<td valign="top" width="133"><span style="color: #c0504d;">私有匿名映射</span></td>
</tr>
</tbody>
</table>
<p>&nbsp;</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> mmap_region(<span style="color: #0000ff;">struct</span> file *file, <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> addr,</pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span>               <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> len, <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> flags,</pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span>               vm_flags_t vm_flags, <span style="color: #0000ff;">unsigned</span> <span style="color: #0000ff;">long</span> pgoff)</pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span> {</pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span> ******</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span> <span style="color: #0000ff;">if</span> (file) {</pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span>         error = -EINVAL;</pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span>         <span style="color: #0000ff;">if</span> (vm_flags &amp; (VM_GROWSDOWN|VM_GROWSUP))</pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span>             <span style="color: #0000ff;">goto</span> free_vma;</pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span>         <span style="color: #0000ff;">if</span> (vm_flags &amp; VM_DENYWRITE) {</pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>             error = deny_write_access(file);</pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span>             <span style="color: #0000ff;">if</span> (error)</pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span>                 <span style="color: #0000ff;">goto</span> free_vma;</pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span>             correct_wcount = 1;</pre>
<!--CRLF-->
<pre><span id="lnum15" style="color: #606060;">  15:</span>         }</pre>
<!--CRLF-->
<pre><span id="lnum16" style="color: #606060;">  16:</span>         vma-&gt;vm_file = file;</pre>
<!--CRLF-->
<pre><span id="lnum17" style="color: #606060;">  17:</span>         get_file(file);</pre>
<!--CRLF-->
<pre><span id="lnum18" style="color: #606060;">  18:</span>         error = file-&gt;f_op-&gt;mmap(file, vma);</pre>
<!--CRLF-->
<pre><span id="lnum19" style="color: #606060;">  19:</span>         <span style="color: #0000ff;">if</span> (error)</pre>
<!--CRLF-->
<pre><span id="lnum20" style="color: #606060;">  20:</span>             <span style="color: #0000ff;">goto</span> unmap_and_free_vma;</pre>
<!--CRLF-->
<pre><span id="lnum21" style="color: #606060;">  21:</span>         <span style="color: #0000ff;">if</span> (vm_flags &amp; VM_EXECUTABLE)</pre>
<!--CRLF-->
<pre><span id="lnum22" style="color: #606060;">  22:</span>             added_exe_file_vma(mm);</pre>
<!--CRLF-->
<pre><span id="lnum23" style="color: #606060;">  23:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum24" style="color: #606060;">  24:</span>         <span style="color: #008000;">/* Can addr have changed??</span></pre>
<!--CRLF-->
<pre><span id="lnum25" style="color: #606060;">  25:</span> <span style="color: #008000;">         *</span></pre>
<!--CRLF-->
<pre><span id="lnum26" style="color: #606060;">  26:</span> <span style="color: #008000;">         * Answer: Yes, several device drivers can do it in their</span></pre>
<!--CRLF-->
<pre><span id="lnum27" style="color: #606060;">  27:</span> <span style="color: #008000;">         *         f_op-&gt;mmap method. -DaveM</span></pre>
<!--CRLF-->
<pre><span id="lnum28" style="color: #606060;">  28:</span> <span style="color: #008000;">         */</span></pre>
<!--CRLF-->
<pre><span id="lnum29" style="color: #606060;">  29:</span>         addr = vma-&gt;vm_start;</pre>
<!--CRLF-->
<pre><span id="lnum30" style="color: #606060;">  30:</span>         pgoff = vma-&gt;vm_pgoff;</pre>
<!--CRLF-->
<pre><span id="lnum31" style="color: #606060;">  31:</span>         vm_flags = vma-&gt;vm_flags;</pre>
<!--CRLF-->
<pre><span id="lnum32" style="color: #606060;">  32:</span>     } <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (vm_flags &amp; VM_SHARED) {</pre>
<!--CRLF-->
<pre><span id="lnum33" style="color: #606060;">  33:</span>         error = shmem_zero_setup(vma);</pre>
<!--CRLF-->
<pre><span id="lnum34" style="color: #606060;">  34:</span>         <span style="color: #0000ff;">if</span> (error)</pre>
<!--CRLF-->
<pre><span id="lnum35" style="color: #606060;">  35:</span>             <span style="color: #0000ff;">goto</span> free_vma;</pre>
<!--CRLF-->
<pre><span id="lnum36" style="color: #606060;">  36:</span>     }</pre>
<!--CRLF-->
<pre><span id="lnum37" style="color: #606060;">  37:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum38" style="color: #606060;">  38:</span> ******</pre>
<!--CRLF-->
<pre><span id="lnum39" style="color: #606060;">  39:</span> }</pre>
<!--CRLF--></div>
</div>
<p>调用file-&gt;f_op-&gt;mmap(file,vma)</p>
<p>对于不同类型的文件系统或者是设备驱动，都定义了各自的mmap函数，我们看一下典型的ext2文件系统：</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span> <span style="color: #008000;"> * We have mostly NULL's here: the current defaults are ok for</span></pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span> <span style="color: #008000;"> * the ext2 filesystem.</span></pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span> <span style="color: #008000;"> */</span></pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span> <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">struct</span> file_operations ext2_file_operations = {</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span>     .llseek        = generic_file_llseek,</pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span>     .read        = do_sync_read,</pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span>     .write        = do_sync_write,</pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span>     .aio_read    = generic_file_aio_read,</pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span>     .aio_write    = generic_file_aio_write,</pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>     .unlocked_ioctl = ext2_ioctl,</pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span> <span style="color: #cc6633;">#ifdef</span> CONFIG_COMPAT</pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span>     .compat_ioctl    = ext2_compat_ioctl,</pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span> <span style="color: #cc6633;">#endif</span></pre>
<!--CRLF-->
<pre><span id="lnum15" style="color: #606060;">  15:</span>     .mmap        = generic_file_mmap,</pre>
<!--CRLF-->
<pre><span id="lnum16" style="color: #606060;">  16:</span>     .open        = dquot_file_open,</pre>
<!--CRLF-->
<pre><span id="lnum17" style="color: #606060;">  17:</span>     .release    = ext2_release_file,</pre>
<!--CRLF-->
<pre><span id="lnum18" style="color: #606060;">  18:</span>     .fsync        = ext2_fsync,</pre>
<!--CRLF-->
<pre><span id="lnum19" style="color: #606060;">  19:</span>     .splice_read    = generic_file_splice_read,</pre>
<!--CRLF-->
<pre><span id="lnum20" style="color: #606060;">  20:</span>     .splice_write    = generic_file_splice_write,</pre>
<!--CRLF-->
<pre><span id="lnum21" style="color: #606060;">  21:</span> };</pre>
<!--CRLF--></div>
</div>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span> <span style="color: #008000;">/* This is used for a general mmap of a disk file */</span></pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span> <span style="color: #0000ff;">int</span> generic_file_mmap(<span style="color: #0000ff;">struct</span> file * file, <span style="color: #0000ff;">struct</span> vm_area_struct * vma)</pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span> {</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span>     <span style="color: #0000ff;">struct</span> address_space *mapping = file-&gt;f_mapping;</pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span>     <span style="color: #0000ff;">if</span> (!mapping-&gt;a_ops-&gt;readpage)</pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span>         <span style="color: #0000ff;">return</span> -ENOEXEC;</pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span>     file_accessed(file);</pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>     vma-&gt;vm_ops = &amp;generic_file_vm_ops;</pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span>     vma-&gt;vm_flags |= VM_CAN_NONLINEAR;</pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span>     <span style="color: #0000ff;">return</span> 0;</pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span> }</pre>
<!--CRLF--></div>
</div>
<p>file_accessed更新时间戳.</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">struct</span> vm_operations_struct generic_file_vm_ops = {</pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span>     .fault        = filemap_fault,</pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span> };</pre>
<!--CRLF--></div>
</div>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #008000;">/**</span></pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span> <span style="color: #008000;"> * filemap_fault - read in file data for page fault handling</span></pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span> <span style="color: #008000;"> * @vma:    vma in which the fault was taken</span></pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span> <span style="color: #008000;"> * @vmf:    struct vm_fault containing details of the fault</span></pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span> <span style="color: #008000;"> *</span></pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span> <span style="color: #008000;"> * filemap_fault() is invoked via the vma operations vector for a</span></pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span> <span style="color: #008000;"> * mapped memory region to read in file data during a page fault.</span></pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span> <span style="color: #008000;"> *</span></pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span> <span style="color: #008000;"> * The goto's are kind of ugly, but this streamlines the normal case of having</span></pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span> <span style="color: #008000;"> * it in the page cache, and handles the special cases reasonably without</span></pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span> <span style="color: #008000;"> * having a lot of duplicated code.</span></pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span> <span style="color: #008000;"> */</span></pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span> <span style="color: #0000ff;">int</span> filemap_fault(<span style="color: #0000ff;">struct</span> vm_area_struct *vma, <span style="color: #0000ff;">struct</span> vm_fault *vmf)</pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span> {</pre>
<!--CRLF-->
<pre><span id="lnum15" style="color: #606060;">  15:</span>     <span style="color: #0000ff;">int</span> error;</pre>
<!--CRLF-->
<pre><span id="lnum16" style="color: #606060;">  16:</span>     <span style="color: #0000ff;">struct</span> file *file = vma-&gt;vm_file;</pre>
<!--CRLF-->
<pre><span id="lnum17" style="color: #606060;">  17:</span>     <span style="color: #0000ff;">struct</span> address_space *mapping = file-&gt;f_mapping;</pre>
<!--CRLF-->
<pre><span id="lnum18" style="color: #606060;">  18:</span>     <span style="color: #0000ff;">struct</span> file_ra_state *ra = &amp;file-&gt;f_ra;</pre>
<!--CRLF-->
<pre><span id="lnum19" style="color: #606060;">  19:</span>     <span style="color: #0000ff;">struct</span> inode *inode = mapping-&gt;host;</pre>
<!--CRLF-->
<pre><span id="lnum20" style="color: #606060;">  20:</span>     pgoff_t offset = vmf-&gt;pgoff;</pre>
<!--CRLF-->
<pre><span id="lnum21" style="color: #606060;">  21:</span>     <span style="color: #0000ff;">struct</span> page *page;</pre>
<!--CRLF-->
<pre><span id="lnum22" style="color: #606060;">  22:</span>     pgoff_t size;</pre>
<!--CRLF-->
<pre><span id="lnum23" style="color: #606060;">  23:</span>     <span style="color: #0000ff;">int</span> ret = 0;</pre>
<!--CRLF-->
<pre><span id="lnum24" style="color: #606060;">  24:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum25" style="color: #606060;">  25:</span>     size = (i_size_read(inode) + PAGE_CACHE_SIZE - 1) &gt;&gt; PAGE_CACHE_SHIFT;</pre>
<!--CRLF-->
<pre><span id="lnum26" style="color: #606060;">  26:</span>     <span style="color: #0000ff;">if</span> (offset &gt;= size)</pre>
<!--CRLF-->
<pre><span id="lnum27" style="color: #606060;">  27:</span>         <span style="color: #0000ff;">return</span> VM_FAULT_SIGBUS;</pre>
<!--CRLF-->
<pre><span id="lnum28" style="color: #606060;">  28:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum29" style="color: #606060;">  29:</span>     <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum30" style="color: #606060;">  30:</span> <span style="color: #008000;">     * Do we have something in the page cache already?</span></pre>
<!--CRLF-->
<pre><span id="lnum31" style="color: #606060;">  31:</span> <span style="color: #008000;">     */</span></pre>
<!--CRLF-->
<pre><span id="lnum32" style="color: #606060;">  32:</span>     page = find_get_page(mapping, offset);</pre>
<!--CRLF-->
<pre><span id="lnum33" style="color: #606060;">  33:</span>     <span style="color: #0000ff;">if</span> (likely(page)) {</pre>
<!--CRLF-->
<pre><span id="lnum34" style="color: #606060;">  34:</span>         <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum35" style="color: #606060;">  35:</span> <span style="color: #008000;">         * We found the page, so try async readahead before</span></pre>
<!--CRLF-->
<pre><span id="lnum36" style="color: #606060;">  36:</span> <span style="color: #008000;">         * waiting for the lock.</span></pre>
<!--CRLF-->
<pre><span id="lnum37" style="color: #606060;">  37:</span> <span style="color: #008000;">         */</span></pre>
<!--CRLF-->
<pre><span id="lnum38" style="color: #606060;">  38:</span>         do_async_mmap_readahead(vma, ra, file, page, offset);</pre>
<!--CRLF-->
<pre><span id="lnum39" style="color: #606060;">  39:</span>     } <span style="color: #0000ff;">else</span> {</pre>
<!--CRLF-->
<pre><span id="lnum40" style="color: #606060;">  40:</span>         <span style="color: #008000;">/* No page in the page cache at all */</span></pre>
<!--CRLF-->
<pre><span id="lnum41" style="color: #606060;">  41:</span>         do_sync_mmap_readahead(vma, ra, file, offset);</pre>
<!--CRLF-->
<pre><span id="lnum42" style="color: #606060;">  42:</span>         count_vm_event(PGMAJFAULT);</pre>
<!--CRLF-->
<pre><span id="lnum43" style="color: #606060;">  43:</span>         mem_cgroup_count_vm_event(vma-&gt;vm_mm, PGMAJFAULT);</pre>
<!--CRLF-->
<pre><span id="lnum44" style="color: #606060;">  44:</span>         ret = VM_FAULT_MAJOR;</pre>
<!--CRLF-->
<pre><span id="lnum45" style="color: #606060;">  45:</span> retry_find:</pre>
<!--CRLF-->
<pre><span id="lnum46" style="color: #606060;">  46:</span>         page = find_get_page(mapping, offset);</pre>
<!--CRLF-->
<pre><span id="lnum47" style="color: #606060;">  47:</span>         <span style="color: #0000ff;">if</span> (!page)</pre>
<!--CRLF-->
<pre><span id="lnum48" style="color: #606060;">  48:</span>             <span style="color: #0000ff;">goto</span> no_cached_page;</pre>
<!--CRLF-->
<pre><span id="lnum49" style="color: #606060;">  49:</span>     }</pre>
<!--CRLF-->
<pre><span id="lnum50" style="color: #606060;">  50:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum51" style="color: #606060;">  51:</span>     <span style="color: #0000ff;">if</span> (!lock_page_or_retry(page, vma-&gt;vm_mm, vmf-&gt;flags)) {</pre>
<!--CRLF-->
<pre><span id="lnum52" style="color: #606060;">  52:</span>         page_cache_release(page);</pre>
<!--CRLF-->
<pre><span id="lnum53" style="color: #606060;">  53:</span>         <span style="color: #0000ff;">return</span> ret | VM_FAULT_RETRY;</pre>
<!--CRLF-->
<pre><span id="lnum54" style="color: #606060;">  54:</span>     }</pre>
<!--CRLF-->
<pre><span id="lnum55" style="color: #606060;">  55:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum56" style="color: #606060;">  56:</span>     <span style="color: #008000;">/* Did it get truncated? */</span></pre>
<!--CRLF-->
<pre><span id="lnum57" style="color: #606060;">  57:</span>     <span style="color: #0000ff;">if</span> (unlikely(page-&gt;mapping != mapping)) {</pre>
<!--CRLF-->
<pre><span id="lnum58" style="color: #606060;">  58:</span>         unlock_page(page);</pre>
<!--CRLF-->
<pre><span id="lnum59" style="color: #606060;">  59:</span>         put_page(page);</pre>
<!--CRLF-->
<pre><span id="lnum60" style="color: #606060;">  60:</span>         <span style="color: #0000ff;">goto</span> retry_find;</pre>
<!--CRLF-->
<pre><span id="lnum61" style="color: #606060;">  61:</span>     }</pre>
<!--CRLF-->
<pre><span id="lnum62" style="color: #606060;">  62:</span>     VM_BUG_ON(page-&gt;index != offset);</pre>
<!--CRLF-->
<pre><span id="lnum63" style="color: #606060;">  63:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum64" style="color: #606060;">  64:</span>     <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum65" style="color: #606060;">  65:</span> <span style="color: #008000;">     * We have a locked page in the page cache, now we need to check</span></pre>
<!--CRLF-->
<pre><span id="lnum66" style="color: #606060;">  66:</span> <span style="color: #008000;">     * that it's up-to-date. If not, it is going to be due to an error.</span></pre>
<!--CRLF-->
<pre><span id="lnum67" style="color: #606060;">  67:</span> <span style="color: #008000;">     */</span></pre>
<!--CRLF-->
<pre><span id="lnum68" style="color: #606060;">  68:</span>     <span style="color: #0000ff;">if</span> (unlikely(!PageUptodate(page)))</pre>
<!--CRLF-->
<pre><span id="lnum69" style="color: #606060;">  69:</span>         <span style="color: #0000ff;">goto</span> page_not_uptodate;</pre>
<!--CRLF-->
<pre><span id="lnum70" style="color: #606060;">  70:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum71" style="color: #606060;">  71:</span>     <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum72" style="color: #606060;">  72:</span> <span style="color: #008000;">     * Found the page and have a reference on it.</span></pre>
<!--CRLF-->
<pre><span id="lnum73" style="color: #606060;">  73:</span> <span style="color: #008000;">     * We must recheck i_size under page lock.</span></pre>
<!--CRLF-->
<pre><span id="lnum74" style="color: #606060;">  74:</span> <span style="color: #008000;">     */</span></pre>
<!--CRLF-->
<pre><span id="lnum75" style="color: #606060;">  75:</span>     size = (i_size_read(inode) + PAGE_CACHE_SIZE - 1) &gt;&gt; PAGE_CACHE_SHIFT;</pre>
<!--CRLF-->
<pre><span id="lnum76" style="color: #606060;">  76:</span>     <span style="color: #0000ff;">if</span> (unlikely(offset &gt;= size)) {</pre>
<!--CRLF-->
<pre><span id="lnum77" style="color: #606060;">  77:</span>         unlock_page(page);</pre>
<!--CRLF-->
<pre><span id="lnum78" style="color: #606060;">  78:</span>         page_cache_release(page);</pre>
<!--CRLF-->
<pre><span id="lnum79" style="color: #606060;">  79:</span>         <span style="color: #0000ff;">return</span> VM_FAULT_SIGBUS;</pre>
<!--CRLF-->
<pre><span id="lnum80" style="color: #606060;">  80:</span>     }</pre>
<!--CRLF-->
<pre><span id="lnum81" style="color: #606060;">  81:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum82" style="color: #606060;">  82:</span>     vmf-&gt;page = page;</pre>
<!--CRLF-->
<pre><span id="lnum83" style="color: #606060;">  83:</span>     <span style="color: #0000ff;">return</span> ret | VM_FAULT_LOCKED;</pre>
<!--CRLF-->
<pre><span id="lnum84" style="color: #606060;">  84:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum85" style="color: #606060;">  85:</span> no_cached_page:</pre>
<!--CRLF-->
<pre><span id="lnum86" style="color: #606060;">  86:</span>     <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum87" style="color: #606060;">  87:</span> <span style="color: #008000;">     * We're only likely to ever get here if MADV_RANDOM is in</span></pre>
<!--CRLF-->
<pre><span id="lnum88" style="color: #606060;">  88:</span> <span style="color: #008000;">     * effect.</span></pre>
<!--CRLF-->
<pre><span id="lnum89" style="color: #606060;">  89:</span> <span style="color: #008000;">     */</span></pre>
<!--CRLF-->
<pre><span id="lnum90" style="color: #606060;">  90:</span>     error = page_cache_read(file, offset);</pre>
<!--CRLF-->
<pre><span id="lnum91" style="color: #606060;">  91:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum92" style="color: #606060;">  92:</span>     <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum93" style="color: #606060;">  93:</span> <span style="color: #008000;">     * The page we want has now been added to the page cache.</span></pre>
<!--CRLF-->
<pre><span id="lnum94" style="color: #606060;">  94:</span> <span style="color: #008000;">     * In the unlikely event that someone removed it in the</span></pre>
<!--CRLF-->
<pre><span id="lnum95" style="color: #606060;">  95:</span> <span style="color: #008000;">     * meantime, we'll just come back here and read it again.</span></pre>
<!--CRLF-->
<pre><span id="lnum96" style="color: #606060;">  96:</span> <span style="color: #008000;">     */</span></pre>
<!--CRLF-->
<pre><span id="lnum97" style="color: #606060;">  97:</span>     <span style="color: #0000ff;">if</span> (error &gt;= 0)</pre>
<!--CRLF-->
<pre><span id="lnum98" style="color: #606060;">  98:</span>         <span style="color: #0000ff;">goto</span> retry_find;</pre>
<!--CRLF-->
<pre><span id="lnum99" style="color: #606060;">  99:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum100" style="color: #606060;"> 100:</span>     <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum101" style="color: #606060;"> 101:</span> <span style="color: #008000;">     * An error return from page_cache_read can result if the</span></pre>
<!--CRLF-->
<pre><span id="lnum102" style="color: #606060;"> 102:</span> <span style="color: #008000;">     * system is low on memory, or a problem occurs while trying</span></pre>
<!--CRLF-->
<pre><span id="lnum103" style="color: #606060;"> 103:</span> <span style="color: #008000;">     * to schedule I/O.</span></pre>
<!--CRLF-->
<pre><span id="lnum104" style="color: #606060;"> 104:</span> <span style="color: #008000;">     */</span></pre>
<!--CRLF-->
<pre><span id="lnum105" style="color: #606060;"> 105:</span>     <span style="color: #0000ff;">if</span> (error == -ENOMEM)</pre>
<!--CRLF-->
<pre><span id="lnum106" style="color: #606060;"> 106:</span>         <span style="color: #0000ff;">return</span> VM_FAULT_OOM;</pre>
<!--CRLF-->
<pre><span id="lnum107" style="color: #606060;"> 107:</span>     <span style="color: #0000ff;">return</span> VM_FAULT_SIGBUS;</pre>
<!--CRLF-->
<pre><span id="lnum108" style="color: #606060;"> 108:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum109" style="color: #606060;"> 109:</span> page_not_uptodate:</pre>
<!--CRLF-->
<pre><span id="lnum110" style="color: #606060;"> 110:</span>     <span style="color: #008000;">/*</span></pre>
<!--CRLF-->
<pre><span id="lnum111" style="color: #606060;"> 111:</span> <span style="color: #008000;">     * Umm, take care of errors if the page isn't up-to-date.</span></pre>
<!--CRLF-->
<pre><span id="lnum112" style="color: #606060;"> 112:</span> <span style="color: #008000;">     * Try to re-read it _once_. We do this synchronously,</span></pre>
<!--CRLF-->
<pre><span id="lnum113" style="color: #606060;"> 113:</span> <span style="color: #008000;">     * because there really aren't any performance issues here</span></pre>
<!--CRLF-->
<pre><span id="lnum114" style="color: #606060;"> 114:</span> <span style="color: #008000;">     * and we need to check for errors.</span></pre>
<!--CRLF-->
<pre><span id="lnum115" style="color: #606060;"> 115:</span> <span style="color: #008000;">     */</span></pre>
<!--CRLF-->
<pre><span id="lnum116" style="color: #606060;"> 116:</span>     ClearPageError(page);</pre>
<!--CRLF-->
<pre><span id="lnum117" style="color: #606060;"> 117:</span>     error = mapping-&gt;a_ops-&gt;readpage(file, page);</pre>
<!--CRLF-->
<pre><span id="lnum118" style="color: #606060;"> 118:</span>     <span style="color: #0000ff;">if</span> (!error) {</pre>
<!--CRLF-->
<pre><span id="lnum119" style="color: #606060;"> 119:</span>         wait_on_page_locked(page);</pre>
<!--CRLF-->
<pre><span id="lnum120" style="color: #606060;"> 120:</span>         <span style="color: #0000ff;">if</span> (!PageUptodate(page))</pre>
<!--CRLF-->
<pre><span id="lnum121" style="color: #606060;"> 121:</span>             error = -EIO;</pre>
<!--CRLF-->
<pre><span id="lnum122" style="color: #606060;"> 122:</span>     }</pre>
<!--CRLF-->
<pre><span id="lnum123" style="color: #606060;"> 123:</span>     page_cache_release(page);</pre>
<!--CRLF-->
<pre><span id="lnum124" style="color: #606060;"> 124:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum125" style="color: #606060;"> 125:</span>     <span style="color: #0000ff;">if</span> (!error || error == AOP_TRUNCATED_PAGE)</pre>
<!--CRLF-->
<pre><span id="lnum126" style="color: #606060;"> 126:</span>         <span style="color: #0000ff;">goto</span> retry_find;</pre>
<!--CRLF-->
<pre><span id="lnum127" style="color: #606060;"> 127:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum128" style="color: #606060;"> 128:</span>     <span style="color: #008000;">/* Things didn't work out. Return zero to tell the mm layer so. */</span></pre>
<!--CRLF-->
<pre><span id="lnum129" style="color: #606060;"> 129:</span>     shrink_readahead_size_eio(file, ra);</pre>
<!--CRLF-->
<pre><span id="lnum130" style="color: #606060;"> 130:</span>     <span style="color: #0000ff;">return</span> VM_FAULT_SIGBUS;</pre>
<!--CRLF-->
<pre><span id="lnum131" style="color: #606060;"> 131:</span> }</pre>
<!--CRLF-->
<pre><span id="lnum132" style="color: #606060;"> 132:</span> EXPORT_SYMBOL(filemap_fault);</pre>
<!--CRLF--></div>
</div>
<p>函数filemap_fault是文件映射的精华，代表着当进程读取映射的地址范围中的某个地址时，如果发生缺页异常，就由该函数负责从文件中读取真实的内容。</p>
<p>&nbsp;</p>
<p>如果请求的页不在address_space-&gt;page_tree中，那么需要重新从文件中读取：</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #008000;">/**</span></pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span> <span style="color: #008000;"> * page_cache_read - adds requested page to the page cache if not already there</span></pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span> <span style="color: #008000;"> * @file:    file to read</span></pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span> <span style="color: #008000;"> * @offset:    page index</span></pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span> <span style="color: #008000;"> *</span></pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span> <span style="color: #008000;"> * This adds the requested page to the page cache if it isn't already there,</span></pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span> <span style="color: #008000;"> * and schedules an I/O to read in its contents from disk.</span></pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span> <span style="color: #008000;"> */</span></pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> page_cache_read(<span style="color: #0000ff;">struct</span> file *file, pgoff_t offset)</pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span> {</pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>     <span style="color: #0000ff;">struct</span> address_space *mapping = file-&gt;f_mapping;</pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span>     <span style="color: #0000ff;">struct</span> page *page; </pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span>     <span style="color: #0000ff;">int</span> ret;</pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum15" style="color: #606060;">  15:</span>     <span style="color: #0000ff;">do</span> {</pre>
<!--CRLF-->
<pre><span id="lnum16" style="color: #606060;">  16:</span>         page = page_cache_alloc_cold(mapping);</pre>
<!--CRLF-->
<pre><span id="lnum17" style="color: #606060;">  17:</span>         <span style="color: #0000ff;">if</span> (!page)</pre>
<!--CRLF-->
<pre><span id="lnum18" style="color: #606060;">  18:</span>             <span style="color: #0000ff;">return</span> -ENOMEM;</pre>
<!--CRLF-->
<pre><span id="lnum19" style="color: #606060;">  19:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum20" style="color: #606060;">  20:</span>         ret = add_to_page_cache_lru(page, mapping, offset, GFP_KERNEL);</pre>
<!--CRLF-->
<pre><span id="lnum21" style="color: #606060;">  21:</span>         <span style="color: #0000ff;">if</span> (ret == 0)</pre>
<!--CRLF-->
<pre><span id="lnum22" style="color: #606060;">  22:</span>             ret = mapping-&gt;a_ops-&gt;readpage(file, page);</pre>
<!--CRLF-->
<pre><span id="lnum23" style="color: #606060;">  23:</span>         <span style="color: #0000ff;">else</span> <span style="color: #0000ff;">if</span> (ret == -EEXIST)</pre>
<!--CRLF-->
<pre><span id="lnum24" style="color: #606060;">  24:</span>             ret = 0; <span style="color: #008000;">/* losing race to add is OK */</span></pre>
<!--CRLF-->
<pre><span id="lnum25" style="color: #606060;">  25:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum26" style="color: #606060;">  26:</span>         page_cache_release(page);</pre>
<!--CRLF-->
<pre><span id="lnum27" style="color: #606060;">  27:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum28" style="color: #606060;">  28:</span>     } <span style="color: #0000ff;">while</span> (ret == AOP_TRUNCATED_PAGE);</pre>
<!--CRLF-->
<pre><span id="lnum29" style="color: #606060;">  29:</span>         </pre>
<!--CRLF-->
<pre><span id="lnum30" style="color: #606060;">  30:</span>     <span style="color: #0000ff;">return</span> ret;</pre>
<!--CRLF-->
<pre><span id="lnum31" style="color: #606060;">  31:</span> }</pre>
<!--CRLF--></div>
</div>
<p>&nbsp;</p>
<p>因为每个inode都只有一个address_space结构体成员，所以所有映射到该inode的内存页面都被维护在page_tree中，这样就可以保证多个进程之间的共享文件机制了，实际上是共享了这些页面。</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000;">但是，对于每个进程都采用私有映射的文件，是怎么处理的呢？</span></p>
<p>&nbsp;</p>
<p><span style="color: #000000;">私有映射的文件，会采用写时复制的机制，这也就是为什么说</span></p>
<blockquote>
<p>MAP_PRIVATE</p>
<p>用于创建一个与数据源分离的私有映射，对区域的写入操作不影响数据源文件中的内容</p>
</blockquote>
<p><span style="color: #000000;">也保证了多个进程对文件的操作上互相独立。</span></p>
<p><strong>可以预见，是没有办法让两个进程同时以写方式，独立地打开同一个文件的内存映射，否则会产生不一致现象。</strong></p>
<p>&nbsp;</p>
<hr />
<p>对于采用共享方式映射的VMA，如果没有后备文件，就采用共享内存的方式映射：</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #008000;">/**</span></pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span> <span style="color: #008000;"> * shmem_zero_setup - setup a shared anonymous mapping</span></pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span> <span style="color: #008000;"> * @vma: the vma to be mmapped is prepared by do_mmap_pgoff</span></pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span> <span style="color: #008000;"> */</span></pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span> <span style="color: #0000ff;">int</span> shmem_zero_setup(<span style="color: #0000ff;">struct</span> vm_area_struct *vma)</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span> {</pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span>     <span style="color: #0000ff;">struct</span> file *file;</pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span>     loff_t size = vma-&gt;vm_end - vma-&gt;vm_start;</pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span>     file = shmem_file_setup(<span style="color: #006080;">"dev/zero"</span>, size, vma-&gt;vm_flags);</pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>     <span style="color: #0000ff;">if</span> (IS_ERR(file))</pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span>         <span style="color: #0000ff;">return</span> PTR_ERR(file);</pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span>     <span style="color: #0000ff;">if</span> (vma-&gt;vm_file)</pre>
<!--CRLF-->
<pre><span id="lnum15" style="color: #606060;">  15:</span>         fput(vma-&gt;vm_file);</pre>
<!--CRLF-->
<pre><span id="lnum16" style="color: #606060;">  16:</span>     vma-&gt;vm_file = file;</pre>
<!--CRLF-->
<pre><span id="lnum17" style="color: #606060;">  17:</span>     vma-&gt;vm_ops = &amp;shmem_vm_ops;</pre>
<!--CRLF-->
<pre><span id="lnum18" style="color: #606060;">  18:</span>     vma-&gt;vm_flags |= VM_CAN_NONLINEAR;</pre>
<!--CRLF-->
<pre><span id="lnum19" style="color: #606060;">  19:</span>     <span style="color: #0000ff;">return</span> 0;</pre>
<!--CRLF-->
<pre><span id="lnum20" style="color: #606060;">  20:</span> }</pre>
<!--CRLF--></div>
</div>
<p>其实是使用设备文件dev/zero来初始化这片内存区域。</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">const</span> <span style="color: #0000ff;">struct</span> vm_operations_struct shmem_vm_ops = {</pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span>     .fault        = shmem_fault,</pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span> <span style="color: #cc6633;">#ifdef</span> CONFIG_NUMA</pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span>     .set_policy     = shmem_set_policy,</pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span>     .get_policy     = shmem_get_policy,</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span> <span style="color: #cc6633;">#endif</span></pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span> };</pre>
<!--CRLF--></div>
</div>
<p>并且采用 shmem_fault来处理缺页异常</p>
<div id="codeSnippetWrapper" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; width: 97.5%; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; cursor: text; border: silver 1px solid; padding: 4px;">
<div id="codeSnippet" style="text-align: left; line-height: 12pt; background-color: #f4f4f4; width: 100%; font-family: 'Courier New', courier, monospace; direction: ltr; color: black; font-size: 8pt; overflow: visible; border-style: none; padding: 0px;">
<pre><span id="lnum1" style="color: #606060;">   1:</span> <span style="color: #0000ff;">static</span> <span style="color: #0000ff;">int</span> shmem_fault(<span style="color: #0000ff;">struct</span> vm_area_struct *vma, <span style="color: #0000ff;">struct</span> vm_fault *vmf)</pre>
<!--CRLF-->
<pre><span id="lnum2" style="color: #606060;">   2:</span> {</pre>
<!--CRLF-->
<pre><span id="lnum3" style="color: #606060;">   3:</span>     <span style="color: #0000ff;">struct</span> inode *inode = vma-&gt;vm_file-&gt;f_path.dentry-&gt;d_inode;</pre>
<!--CRLF-->
<pre><span id="lnum4" style="color: #606060;">   4:</span>     <span style="color: #0000ff;">int</span> error;</pre>
<!--CRLF-->
<pre><span id="lnum5" style="color: #606060;">   5:</span>     <span style="color: #0000ff;">int</span> ret;</pre>
<!--CRLF-->
<pre><span id="lnum6" style="color: #606060;">   6:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum7" style="color: #606060;">   7:</span>     <span style="color: #0000ff;">if</span> (((loff_t)vmf-&gt;pgoff &lt;&lt; PAGE_CACHE_SHIFT) &gt;= i_size_read(inode))</pre>
<!--CRLF-->
<pre><span id="lnum8" style="color: #606060;">   8:</span>         <span style="color: #0000ff;">return</span> VM_FAULT_SIGBUS;</pre>
<!--CRLF-->
<pre><span id="lnum9" style="color: #606060;">   9:</span>&nbsp; </pre>
<!--CRLF-->
<pre><span id="lnum10" style="color: #606060;">  10:</span>     error = shmem_getpage(inode, vmf-&gt;pgoff, &amp;vmf-&gt;page, SGP_CACHE, &amp;ret);</pre>
<!--CRLF-->
<pre><span id="lnum11" style="color: #606060;">  11:</span>     <span style="color: #0000ff;">if</span> (error)</pre>
<!--CRLF-->
<pre><span id="lnum12" style="color: #606060;">  12:</span>         <span style="color: #0000ff;">return</span> ((error == -ENOMEM) ? VM_FAULT_OOM : VM_FAULT_SIGBUS);</pre>
<!--CRLF-->
<pre><span id="lnum13" style="color: #606060;">  13:</span>     <span style="color: #0000ff;">if</span> (ret &amp; VM_FAULT_MAJOR) {</pre>
<!--CRLF-->
<pre><span id="lnum14" style="color: #606060;">  14:</span>         count_vm_event(PGMAJFAULT);</pre>
<!--CRLF-->
<pre><span id="lnum15" style="color: #606060;">  15:</span>         mem_cgroup_count_vm_event(vma-&gt;vm_mm, PGMAJFAULT);</pre>
<!--CRLF-->
<pre><span id="lnum16" style="color: #606060;">  16:</span>     }</pre>
<!--CRLF-->
<pre><span id="lnum17" style="color: #606060;">  17:</span>     <span style="color: #0000ff;">return</span> ret | VM_FAULT_LOCKED;</pre>
<!--CRLF-->
<pre><span id="lnum18" style="color: #606060;">  18:</span> }</pre>
<!--CRLF--></div>
</div></body>
</html>

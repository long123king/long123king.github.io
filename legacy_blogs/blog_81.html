<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<title>PE&#x6587;&#x4EF6;&#x57FA;&#x7840;</title>
<body><p>参考项目：<a title="https://code.google.com/p/portable-executable-library/" href="https://code.google.com/p/portable-executable-library/">https://code.google.com/p/portable-executable-library/</a></p> <h3>1. RVA与VA，File Offset</h3> <p>参考：<a title="http://www.pediy.com/kssd/pediy10/61737.html" href="http://www.pediy.com/kssd/pediy10/61737.html">http://www.pediy.com/kssd/pediy10/61737.html</a></p> <p>VA是内存中的真实的虚拟地址值；</p> <p>RVA是VA相对于ImageBase的相对偏移；</p> <p>而File Offset就是在PE映像文件中相对于文件开始处的偏移。</p> <p>&nbsp;</p> <p>PE文件的布局与最终加载到内存中的布局是不完全相同的，主要是因为有一些对齐的要求。</p> <p>在加载到内存时，粒度是section，也就是说一个section里面的内容会被加载到内存中连续的一片区域。</p> <p>因此，在一个section内部，所有内容的RVA/VA/File Offset是遵循相同的函数关系的。</p> <p>&nbsp;</p> <p>这个函数关系的信息，是保存在PE文件的section header结构中的。</p> <p>&nbsp;</p> <p>PE内部的地址都是以RVA形式保存的，从RVA转换到VA很简单，只需要获取到PE加载到内存中的ImageBase。</p> <p>虽然PE头部也会指定其“钟意”的基地址，但是很有可能最终没有被加载到这里。</p> <p>&nbsp;</p> <p>从RVA到File Offset的转换就是与具体的section相关的了。</p> <p>PE Bliss对于RVA到File Offset的转换代码如下：</p> <div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"> <div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #008000">//RVA to RAW file offset convertion (4gb max)</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">uint32_t pe_base::rva_to_file_offset(uint32_t rva) <span style="color: #0000ff">const</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">{</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #008000">//Maybe, RVA is inside PE headers</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">if</span>(rva &lt; get_size_of_headers())</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">        <span style="color: #0000ff">return</span> rva;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">&nbsp;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">const</span> section&amp; s = section_from_rva(rva);</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">    <span style="color: #0000ff">return</span> s.get_pointer_to_raw_data() + rva - s.get_virtual_address();</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">}</pre><!--CRLF--></div></div>
<p>因为一个section里的内容的file offset与rva之间的偏移关系是相同的，即</p>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">A.rva - A.offset = B.rva - B.offset</pre><!--CRLF--></div></div>
<p>即</p>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">A.offset = B.rva + A.rva - B.offset</pre><!--CRLF--></div></div>
<p>将B选取为这个section的头部，而A是该section中的任意一点，那么A.offset就可以通过上面的公式求出。</p>
<p>&nbsp;</p>
<h3>2. 导入表</h3>
<p>导入表揭示了PE文件对于其他PE文件的依赖关系。</p>
<p>当一个PE文件需要使用其他PE文件定义的函数或者变量时，需要知道这些内容在内存中的具体加载地址。</p>
<p>这个信息是在链接过程中写入到PE文件中，要保证这个信息的正确，必须对依赖的那些PE文件的布局有了解，这也是为什么一个PE文件在链接时，需要指明它所依赖的其他PE文件的lib文件，因为lib文件就提供了这些相对位置的信息。</p>
<p>这些相对位置，其实就是函数或者变量在其他PE文件中的RVA。</p>
<p>&nbsp;</p>
<h3>3. 为什么PE文件中使用的地址都用RVA形式表示</h3>
<p>因为PE真正关心的是当它自己被拉起来运行时，它需要的内容要到内存中的哪个位置去找，而不是要到文件中的哪个位置去找。因此它关心其实是VA，而一旦相关映像被加载到内存中了，那么它们的ImageBase也就确定了，所以知道了RVA，就知道了VA。</p></body>
</html>

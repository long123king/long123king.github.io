<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<title>DynamoRIO&#x521D;&#x8BD5;</title>
<body><p>经历了pin的一些苦痛经历，DynamoRIO成为second option.</p> <p>&nbsp;</p> <p>二者无论从运作方式，还是内部实现，都十分相似，肯定是一方抄袭了另外一方。</p> <p>&nbsp;</p> <p>编译DynamoRIO client：</p> <p>&nbsp;</p> <p>Wrong</p> <div id="codeSnippetWrapper"> <div id="codeSnippetWrapper"> <div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">cl /O2 /I <span style="color: #006080">"..\include"</span> /I <span style="color: #006080">"..\ext\include"</span> /D <span style="color: #006080">"WIN32"</span> /D <span style="color: #006080">"NDEBUG"</span> /D <span style="color: #006080">"_WINDOWS"</span> /D <span style="color: #006080">"X86_32"</span> /D <span style="color: #006080">"WINDOWS"</span> /D <span style="color: #006080">"_USRDLL"</span> /D <span style="color: #006080">"PROFILER_EXPORTS"</span> /D <span style="color: #006080">"_WINDLL"</span> /D <span style="color: #006080">"_UNICODE"</span> /D <span style="color: #006080">"UNICODE"</span> /FD /MD /GS- /Fo<span style="color: #006080">"Release\\" /Fd"</span>Release\vc80.pdb" /W3 /c /Wp64 /TC .\main.cpp /link /libpath:../lib32/release dynamorio.lib /dll /out:Profiler.dll</pre><!--CRLF--></div></div>Right</div>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">cl /O2 /I <span style="color: #006080">"..\include"</span> /I <span style="color: #006080">"..\ext\include"</span> /D <span style="color: #006080">"WIN32"</span> /D <span style="color: #006080">"NDEBUG"</span> /D <span style="color: #006080">"_WINDOWS"</span> /D <span style="color: #006080">"X86_32"</span> /D <span style="color: #006080">"WINDOWS"</span> /D <span style="color: #006080">"_USRDLL"</span> /D <span style="color: #006080">"PROFILER_EXPORTS"</span> /D <span style="color: #006080">"_WINDLL"</span> /D <span style="color: #006080">"_UNICODE"</span> /D <span style="color: #006080">"UNICODE"</span> /GS- .\main.cpp /link /libpath:../lib32/release dynamorio.lib /dll /out:Profiler.dll</pre><!--CRLF--></div></div>
<p>Right</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">cl main.cpp /I../include /GS- /DWINDOWS /DX86_32 /link /libpath:../lib32/release dynamorio.lib /dll /out:Profiler.dll</pre><!--CRLF--></div></div>
<p>&nbsp;</p>
<p>What is the difference?</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">/FD /MD /Fo<span style="color: #006080">"Release\\" /Fd"</span>Release\vc80.pdb" /W3 /c /Wp64 /TC </pre><!--CRLF--></div></div>
<div>&nbsp;</div>



<p>去掉/c，就能够生成dll了，可见/c是只编译。</p>
<p>&nbsp;</p>
<p>除此之外，还要加上下面选项</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">/link /libpath:../lib32/release dynamorio.lib /dll /out:Profiler.dll</pre><!--CRLF--></div></div>

<p>&nbsp;</p>
<p>将</p>
<p><a href="http://images.cnitblog.com/blog/580388/201404/300959252052320.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; border-top: 0px; margin-right: auto; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://long123king.github.io/legacy_blogs/img/blog_159_blog_159_300959256585391.png" width="644" height="449"></a></p>
<p>中的内容复制，然后在前面添加</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">cl main.cpp </pre><!--CRLF--></div></div>
<p>组成下面的命令行，在VC Prompt中执行</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">cl main.cpp /O2 /I <span style="color: #006080">"..\include"</span> /I <span style="color: #006080">"..\ext\include"</span> /D <span style="color: #006080">"WIN32"</span> /D <span style="color: #006080">"NDEBUG"</span> /D <span style="color: #006080">"_WINDOWS"</span> /D <span style="color: #006080">"X86_32"</span> /D <span style="color: #006080">"WINDOWS"</span> /D <span style="color: #006080">"_USRDLL"</span> /D <span style="color: #006080">"PROFILER_EXPORTS"</span> /D <span style="color: #006080">"_WINDLL"</span> /D <span style="color: #006080">"_UNICODE"</span> /D <span style="color: #006080">"UNICODE"</span> /FD /MD /GS- /Fo<span style="color: #006080">"Release\\" /Fd"</span>Release\vc80.pdb" /W3 /c /Wp64 /TC /errorReport:prompt</pre><!--CRLF--></div></div>

<p>&nbsp;</p>
<p>同样对于Linker中的Command Line：</p>
<p>Wrong</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">cl release\main.obj /link /OUT:<span style="color: #006080">"ProfilerD.dll"</span> /INCREMENTAL:NO /NOLOGO /LIBPATH:<span style="color: #006080">"H:\Coverit\trunk\DynamoRIO\lib32\release"</span> /DLL /MACHINE:X86 dynamorio.lib  kernel32.lib user32.lib gdi32.lib winspool.lib comdlg32.lib advapi32.lib shell32.lib ole32.lib oleaut32.lib uuid.lib odbc32.libodbccp32.lib</pre><!--CRLF--></div></div>

<p>&nbsp;</p>
<p>因此，还是这几个选项导致的错误</p>
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">/FD /MD /Fo<span style="color: #006080">"Release\\" /Fd"</span>Release\vc80.pdb" /W3 /c /Wp64 /TC </pre><!--CRLF--></div>
<p>&nbsp;</p>
<p>几番尝试，发现用/MT替换/MD，可以解决问题。</p></body>
</html>

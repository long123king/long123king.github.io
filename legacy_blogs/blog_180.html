<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<title>Cuckoo&#x67B6;&#x6784;</title>
<body><p>cuckoo在部署阶段，只在Guest系统里塞了一个agent，这个agent在运行阶段负责与Host端程序进行通信，从Host端接收sample, 整个客户端程序，以及配置文件。</p> <p>&nbsp;</p> <p>在Host端主要的源文件为：</p> <div class="cnblogs_Highlighter"><pre class="brush:cpp;gutter:true;">./lib/cuckoo/core/scheduler.py
</pre></div>
<div class="cnblogs_Highlighter">
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre><span style="color: #0000ff">class</span> AnalysisManager(Thread):</pre><!--CRLF--><pre>    def acquire_machine(self):</pre><!--CRLF--><pre><span style="color: #008000">// 获得虚拟机    </span></pre><!--CRLF--><pre>    def build_options(self):</pre><!--CRLF--><pre><span style="color: #008000">//生成.conf配置文件</span></pre><!--CRLF--><pre>    def launch_analysis(self):</pre><!--CRLF--><pre><span style="color: #008000">//启动分析过程</span></pre><!--CRLF--><pre>    def process_results(self):</pre><!--CRLF--><pre><span style="color: #008000">//生成分析结果报告</span></pre><!--CRLF--></div></div></div>
<p>&nbsp;</p>
<p>launch_analysis会调用：</p>
<div class="cnblogs_Highlighter">
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre>agent/agent.py</pre><!--CRLF--><pre>    def add_malware(self, data, name):</pre><!--CRLF--><pre>    def add_config(self, options):</pre><!--CRLF--><pre>    def add_analyzer(self, data):</pre><!--CRLF--><pre>    def execute(self):</pre><!--CRLF--></div></div></div>
<p>&nbsp;</p>
<p>执行analyser.py，由Host上传到Guest上的分析程序包含如下结构：</p>
<div class="cnblogs_Highlighter">
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre>.</pre><!--CRLF--><pre>└── windows</pre><!--CRLF--><pre>    ├── analyzer.py</pre><!--CRLF--><pre>    ├── bin</pre><!--CRLF--><pre>    │   └── execsc.exe</pre><!--CRLF--><pre>    ├── dll</pre><!--CRLF--><pre>    │   ├── cuckoomon_bson.dll</pre><!--CRLF--><pre>    │   ├── cuckoomon.dll</pre><!--CRLF--><pre>    │   └── cuckoomon_netlog.dll</pre><!--CRLF--><pre>    ├── lib</pre><!--CRLF--><pre>    │   ├── api</pre><!--CRLF--><pre>    │   │   ├── __init__.py</pre><!--CRLF--><pre>    │   │   ├── process.py</pre><!--CRLF--><pre>    │   │   └── screenshot.py</pre><!--CRLF--><pre>    │   ├── common</pre><!--CRLF--><pre>    │   │   ├── abstracts.py</pre><!--CRLF--><pre>    │   │   ├── constants.py</pre><!--CRLF--><pre>    │   │   ├── defines.py</pre><!--CRLF--><pre>    │   │   ├── errors.py</pre><!--CRLF--><pre>    │   │   ├── exceptions.py</pre><!--CRLF--><pre>    │   │   ├── __init__.py</pre><!--CRLF--><pre>    │   │   ├── rand.py</pre><!--CRLF--><pre>    │   │   └── results.py</pre><!--CRLF--><pre>    │   ├── core</pre><!--CRLF--><pre>    │   │   ├── config.py</pre><!--CRLF--><pre>    │   │   ├── __init__.py</pre><!--CRLF--><pre>    │   │   ├── packages.py</pre><!--CRLF--><pre>    │   │   ├── privileges.py</pre><!--CRLF--><pre>    │   │   └── startup.py</pre><!--CRLF--><pre>    │   └── __init__.py</pre><!--CRLF--><pre>    └── modules</pre><!--CRLF--><pre>        ├── auxiliary</pre><!--CRLF--><pre>        │   ├── disguise.py</pre><!--CRLF--><pre>        │   ├── human.py</pre><!--CRLF--><pre>        │   ├── __init__.py</pre><!--CRLF--><pre>        │   └── screenshots.py</pre><!--CRLF--><pre>        ├── __init__.py</pre><!--CRLF--><pre>        └── packages</pre><!--CRLF--><pre>            ├── applet.py</pre><!--CRLF--><pre>            ├── bin.py</pre><!--CRLF--><pre>            ├── cpl.py</pre><!--CRLF--><pre>            ├── dll.py</pre><!--CRLF--><pre>            ├── doc.py</pre><!--CRLF--><pre>            ├── exe.py</pre><!--CRLF--><pre>            ├── generic.py</pre><!--CRLF--><pre>            ├── html.py</pre><!--CRLF--><pre>            ├── ie.py</pre><!--CRLF--><pre>            ├── __init__.py</pre><!--CRLF--><pre>            ├── jar.py</pre><!--CRLF--><pre>            ├── pdf.py</pre><!--CRLF--><pre>            ├── vbs.py</pre><!--CRLF--><pre>            ├── xls.py</pre><!--CRLF--><pre>            └── zip.py</pre><!--CRLF--></div></div></div>
<p>具体的inject方法在该包的api/process.py下面</p>
<div class="cnblogs_Highlighter">
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre>def inject(self, dll=None, apc=False):</pre><!--CRLF--></div></div></div>
<p>inject方法支持两种注入方式：</p>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre>QueueUserAPC</pre><!--CRLF--><pre>CreateRemoteThread</pre><!--CRLF--></div></div>
<p>这两种方式的原理都是一样的，都是用LoadLibrary来替换回调函数，同时将需要加载的dll名称作为回调的参数传递给回调函数，这样回调函数一执行，相应的dll就被加载到了进行的地址空间中。</p>
<p>&nbsp;</p>
<p>在./analyser/windows/modules/packages/下面有对于各个文件格式的sample的启动代码，基本上都是：</p>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre>p = Process()</pre><!--CRLF--><pre>p.execute()</pre><!--CRLF--><pre>p.inject(dll)</pre><!--CRLF--><pre>p.resume()</pre><!--CRLF--><pre>p.close()</pre><!--CRLF--></div></div>
<p>基本上就是，先找到启动某一类型文件的程序，然后启动它，并且注入dll进行监控。</p>
<p>对于shellcode，使用execsc.exe执行这段shellcode。</p>
<p>execsc.exe的主要源码为：</p>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #008000">// jump into shellcode</span></pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px"><span style="color: #0000ff">int</span> (*func)();</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">func = (<span style="color: #0000ff">int</span> (*)()) buf;</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">(<span style="color: #0000ff">int</span>)(*func)();</pre><!--CRLF--></div></div></body>
</html>

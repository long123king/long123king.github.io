<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<title>Microsoft specification</title>
<body><p><a title="http://msdn.microsoft.com/en-US/" href="http://msdn.microsoft.com/en-US/">http://msdn.microsoft.com/en-US/</a></p> <p>搜索</p> <p>specification</p> <p>&nbsp;</p> <p>搜索“PE COFF specification”，得到一篇Microsoft官方的PE格式文档：</p> <p><a title="http://download.microsoft.com/download/9/c/5/9c5b2167-8017-4bae-9fde-d599bac8184a/pecoff_v83.docx" href="http://download.microsoft.com/download/9/c/5/9c5b2167-8017-4bae-9fde-d599bac8184a/pecoff_v83.docx">http://download.microsoft.com/download/9/c/5/9c5b2167-8017-4bae-9fde-d599bac8184a/pecoff_v83.docx</a></p> <p>这是我读过的讲解最清晰的关于PE格式的文档。</p> <p>&nbsp;</p> <h3>1. export、import与符号链接</h3> <p>关于dll的好处，这里不再详述，总之，dll机制带来了空间与时间上的效率提升。</p> <p>dll是一种shared library机制，是一个封装“代码、数据和资源”的模块，现在几乎没有不依赖于dll的应用程序了。</p> <p>&nbsp;</p> <p>当一个可执行文件（exe）被用来创建一个进程时，该exe文件会被Windows操作系统的组件“加载器”加载到进程的内存地址空间中；如果应用程序引用到了其他dll模块中的符号（函数或者变量），就需要将这些dll也加载到进程的地址空间中，由于ASLR等等客观原因影响，exe中引用外部符号的代码块无法提前预知dll中的某个符号被加载到内存地址空间的什么位置上，因此它需要一种提示机制来指导加载器在加载的过程中解析引用符号的真正地址。</p> <p>&nbsp;</p> <p>这种机制可以被称为是“符号链接”，或者说是“加载时的符号链接”，它依赖于exe中的import table以及dll中的export table给出的提示信息。</p> <p>&nbsp;</p> <p>import table提供以下信息：</p> <div id="codeSnippetWrapper"> <div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">[dll name] + [symbol ordinal that index into dll's <span style="color: #0000ff">export</span> table entry]</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">[dll name] + [symbol name]</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">&nbsp;</pre><!--CRLF--></div></div>
<p>而export table则提供symbol name到symbol ordinal的映射关系，然后以symbol ordinal作为index到export table中找到符号的真正地址（dll被加载到内存地址空间后，符号的内存地址）</p>
<p>&nbsp;</p>
<p>import table的布局：</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">Import Directory Table * 1</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">Import Lookup Table * N</pre><!--CRLF--><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: white; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px">Hint/Name Table * 1</pre><!--CRLF--></div></div></body>
</html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<title>&#x4F7F;&#x7528;Netfilter&#x8FDB;&#x884C;&#x6570;&#x636E;&#x5305;&#x5206;&#x6790;</title>
<body><div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><span style="color: #cc6633">#include</span> &lt;linux/init.h&gt;<br><span style="color: #cc6633">#include</span> &lt;linux/module.h&gt;<br><span style="color: #cc6633">#include</span> &lt;linux/skbuff.h&gt;<br><span style="color: #cc6633">#include</span> &lt;linux/ip.h&gt;<br><span style="color: #cc6633">#include</span> &lt;linux/netfilter.h&gt;<br><span style="color: #cc6633">#include</span> &lt;linux/netfilter_ipv4.h&gt;<br><br>MODULE_LICENSE(<span style="color: #006080">"GPL"</span>);<br><br><span style="color: #0000ff">void</span> analyzeIPHeader(<span style="color: #0000ff">struct</span> iphdr* ip_hdr)<br>{<br>    printk(<span style="color: #006080">"***********IP Header***********\n"</span>);<br>    printk(<span style="color: #006080">"%30s:\t0x%02x\n"</span>, <span style="color: #006080">"Version"</span>, <br>            ip_hdr-&gt;version);<br><br>    printk(<span style="color: #006080">"%30s:\t0x%02x (%u)\n"</span>, <span style="color: #006080">"Header Length(Bytes)"</span>, <br>        ip_hdr-&gt;ihl, <br>        ip_hdr-&gt;ihl);<br>    <br>    printk(<span style="color: #006080">"%30s:\t0x%02x\n"</span>, <span style="color: #006080">"Type of service"</span>, <br>        ip_hdr-&gt;tos);<br><br>    printk(<span style="color: #006080">"%30s:\t0x%04x (%u)\n"</span>, <span style="color: #006080">"Total Length(Bytes)"</span>, <br>        ip_hdr-&gt;tot_len, <br>        ip_hdr-&gt;tot_len);<br><br>    printk(<span style="color: #006080">"%30s:\t0x%04x (%u)\n"</span>, <span style="color: #006080">"Identification"</span>, <br>        ip_hdr-&gt;id,<br>        ip_hdr-&gt;id);<br><br>    printk(<span style="color: #006080">"%30s:\t0x%04x (%u)\n"</span>, <span style="color: #006080">"Fragment Offset"</span>, <br>        ip_hdr-&gt;frag_off,<br>        ip_hdr-&gt;frag_off);<br><br>    printk(<span style="color: #006080">"%30s:\t0x%02x\n"</span>, <span style="color: #006080">"Time to live"</span>, <br>        ip_hdr-&gt;ttl);<br><br>    printk(<span style="color: #006080">"%30s:\t0x%02x"</span>, <span style="color: #006080">"Protocol"</span>, <br>        ip_hdr-&gt;protocol);<br><br>    <br>    <span style="color: #0000ff">if</span> (ip_hdr-&gt;protocol == 0x11)<br>    {<br>        printk(<span style="color: #006080">" [UDP]\n"</span>);<br>    }<br>    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (ip_hdr-&gt;protocol == 0x06)<br>    {<br>        printk(<span style="color: #006080">" [TCP]\n"</span>);<br>    }<br>    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (ip_hdr-&gt;protocol == 0x01)<br>    {<br>        printk(<span style="color: #006080">" [ICMP]\n"</span>);<br>    }<br>    <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (ip_hdr-&gt;protocol == 0x02)<br>    {<br>        printk(<span style="color: #006080">" [IGMP]\n"</span>);<br>    }<br><br>    printk(<span style="color: #006080">"%30s:\t0x%04x\n"</span>, <span style="color: #006080">"Header Checksum (CRC)"</span>, <br>        ip_hdr-&gt;check);<br><br>    printk(<span style="color: #006080">"%30s:\t%u:%u:%u:%u\n"</span>, <span style="color: #006080">"Source IP Address"</span>, <br>        *(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)(((<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)&amp;ip_hdr-&gt;saddr) + 0),<br>        *(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)(((<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)&amp;ip_hdr-&gt;saddr) + 1),<br>        *(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)(((<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)&amp;ip_hdr-&gt;saddr) + 2),<br>        *(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)(((<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)&amp;ip_hdr-&gt;saddr) + 3)<br>        );<br><br>    printk(<span style="color: #006080">"%30s:\t%u:%u:%u:%u\n"</span>, <span style="color: #006080">"Destination IP Address"</span>, <br>        *(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)(((<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)&amp;ip_hdr-&gt;daddr) + 0),<br>        *(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)(((<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)&amp;ip_hdr-&gt;daddr) + 1),<br>        *(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)(((<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)&amp;ip_hdr-&gt;daddr) + 2),<br>        *(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)(((<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">char</span>*)&amp;ip_hdr-&gt;daddr) + 3)<br>        );<br><br>}<br><br><span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">int</span> hook_func(<span style="color: #0000ff">unsigned</span> <span style="color: #0000ff">int</span> hooknum,<br>    <span style="color: #0000ff">struct</span> sk_buff *skb,<br>    <span style="color: #0000ff">const</span> <span style="color: #0000ff">struct</span> net_device *in,<br>    <span style="color: #0000ff">const</span> <span style="color: #0000ff">struct</span> net_device *out,<br>    <span style="color: #0000ff">int</span> (*okfn)(<span style="color: #0000ff">struct</span> sk_buff *))<br>{<br>    <span style="color: #0000ff">struct</span> sk_buff *sb = skb;<br>    <span style="color: #0000ff">struct</span> iphdr *iph ;<br>    <br><br>    <span style="color: #0000ff">if</span> (sb != NULL)<br>    {<br>        iph = ip_hdr(sb);<br><br>        <span style="color: #008000">// printk("sk_buff : 0x%08x ip_hdr : 0x%08x \n", sb, iph);</span><br>        <span style="color: #0000ff">if</span> (iph != NULL)<br>        {<br>            <span style="color: #008000">// printk("ip: %d:%d\n", iph-&gt;saddr, iph-&gt;daddr);</span><br>            analyzeIPHeader(iph);<br>        }    <br>    }<br><br>    <span style="color: #0000ff">return</span> NF_ACCEPT;    <br>}<br><br><br><span style="color: #0000ff">static</span> <span style="color: #0000ff">struct</span> nf_hook_ops hook_ops = {<br>    .hook = hook_func,<br>    .hooknum = NF_INET_PRE_ROUTING,<br>    .pf = PF_INET,<br>    .priority = NF_IP_PRI_FIRST,<br>};<br><br><span style="color: #0000ff">static</span> <span style="color: #0000ff">int</span> pslist_init()<br>{<br>    printk(<span style="color: #006080">"###################################################################\n"</span>);<br><br>    <span style="color: #008000">// analyzeRegisters();</span><br>    <span style="color: #008000">// analyzeUMANode();</span><br>    <span style="color: #008000">// analyzeProcesses();</span><br>    <span style="color: #008000">// analyzePhysicalPages();</span><br>    <span style="color: #008000">// analyzeTaskPgd();</span><br>    <span style="color: #008000">// cpuidTest();</span><br>    <span style="color: #008000">// netanalyze();</span><br>    nf_register_hook(&amp;hook_ops);<br>    <span style="color: #0000ff">return</span> 0;<br>}<br><br><span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> pslist_exit()<br>{<br>    nf_unregister_hook(&amp;hook_ops);<br>    printk(<span style="color: #006080">"###################################################################\n"</span>);<br>}<br><br><br><br>module_init(pslist_init);<br>module_exit(pslist_exit);</pre><br></div>
<p>结果如下：</p>
<div style="border-bottom: silver 1px solid; text-align: left; border-left: silver 1px solid; padding-bottom: 4px; line-height: 12pt; background-color: #f4f4f4; margin: 20px 0px 10px; padding-left: 4px; width: 97.5%; padding-right: 4px; font-family: 'Courier New', courier, monospace; direction: ltr; max-height: 200px; font-size: 8pt; overflow: auto; border-top: silver 1px solid; cursor: text; border-right: silver 1px solid; padding-top: 4px" id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet">[ 3026.194484] ***********IP Header***********<br>[ 3026.194487]                        Version:    0x04<br>[ 3026.194489]           Header Length(Bytes):    0x05 (5)<br>[ 3026.194490]                Type of service:    0x00<br>[ 3026.194491]            Total Length(Bytes):    0x7c00 (31744)<br>[ 3026.194492]                 Identification:    0xdd24 (56612)<br>[ 3026.194493]                Fragment Offset:    0x0000 (0)<br>[ 3026.194494]                   Time to live:    0x40<br>[ 3026.194494]                       Protocol:    0x11 [UDP]<br>[ 3026.194496]          Header Checksum (CRC):    0x0f3e<br>[ 3026.194497]              Source IP Address:    10:64:1:55<br>[ 3026.194498]         Destination IP Address:    127:0:0:1<br>[ 3026.439485] ***********IP Header***********<br>[ 3026.439489]                        Version:    0x04<br>[ 3026.439490]           Header Length(Bytes):    0x05 (5)<br>[ 3026.439491]                Type of service:    0x00<br>[ 3026.439492]            Total Length(Bytes):    0x2800 (10240)<br>[ 3026.439493]                 Identification:    0xde24 (56868)<br>[ 3026.439494]                Fragment Offset:    0x0000 (0)<br>[ 3026.439495]                   Time to live:    0x40<br>[ 3026.439496]                       Protocol:    0x06 [TCP]<br>[ 3026.439497]          Header Checksum (CRC):    0x5d03<br>[ 3026.439499]              Source IP Address:    115:239:210:151<br>[ 3026.439500]         Destination IP Address:    127:0:0:1<br>[ 3026.746484] ***********IP Header***********<br>[ 3026.746495]                        Version:    0x04<br>[ 3026.746503]           Header Length(Bytes):    0x05 (5)<br>[ 3026.746504]                Type of service:    0x00<br>[ 3026.746505]            Total Length(Bytes):    0x2800 (10240)<br>[ 3026.746506]                 Identification:    0xdf24 (57124)<br>[ 3026.746507]                Fragment Offset:    0x0000 (0)<br>[ 3026.746508]                   Time to live:    0x40<br>[ 3026.746509]                       Protocol:    0x06 [TCP]<br>[ 3026.746510]          Header Checksum (CRC):    0x7b11<br>[ 3026.746511]              Source IP Address:    180:149:131:210<br>[ 3026.746513]         Destination IP Address:    127:0:0:1<br>[ 3028.557038] ***********IP Header***********<br>[ 3028.557042]                        Version:    0x04<br>[ 3028.557043]           Header Length(Bytes):    0x05 (5)<br>[ 3028.557044]                Type of service:    0x00<br>[ 3028.557045]            Total Length(Bytes):    0x2800 (10240)<br>[ 3028.557046]                 Identification:    0xe024 (57380)<br>[ 3028.557047]                Fragment Offset:    0x0000 (0)<br>[ 3028.557048]                   Time to live:    0x40<br>[ 3028.557049]                       Protocol:    0x06 [TCP]<br>[ 3028.557050]          Header Checksum (CRC):    0x6329<br>[ 3028.557052]              Source IP Address:    61:160:226:222<br>[ 3028.557053]         Destination IP Address:    127:0:0:1<br>[ 3028.617738] ***********IP Header***********<br>[ 3028.617742]                        Version:    0x04<br>[ 3028.617743]           Header Length(Bytes):    0x05 (5)<br>[ 3028.617744]                Type of service:    0x00<br>[ 3028.617746]            Total Length(Bytes):    0x2800 (10240)<br>[ 3028.617747]                 Identification:    0xe124 (57636)<br>[ 3028.617748]                Fragment Offset:    0x0000 (0)<br>[ 3028.617749]                   Time to live:    0x40<br>[ 3028.617749]                       Protocol:    0x06 [TCP]<br>[ 3028.617751]          Header Checksum (CRC):    0x74ca<br>[ 3028.617752]              Source IP Address:    58:221:68:143<br>[ 3028.617753]         Destination IP Address:    127:0:0:1<br>[ 3028.624231] ***********IP Header***********<br>[ 3028.624234]                        Version:    0x04<br>[ 3028.624235]           Header Length(Bytes):    0x05 (5)<br>[ 3028.624236]                Type of service:    0x00<br>[ 3028.624237]            Total Length(Bytes):    0x2800 (10240)<br>[ 3028.624238]                 Identification:    0xe224 (57892)<br>[ 3028.624239]                Fragment Offset:    0x0000 (0)<br>[ 3028.624240]                   Time to live:    0x40<br>[ 3028.624241]                       Protocol:    0x06 [TCP]<br>[ 3028.624243]          Header Checksum (CRC):    0x6fef<br>[ 3028.624244]              Source IP Address:    58:216:31:152<br>[ 3028.624245]         Destination IP Address:    127:0:0:1<br>[ 3030.353175] ***********IP Header***********<br>[ 3030.353179]                        Version:    0x04<br>[ 3030.353180]           Header Length(Bytes):    0x05 (5)<br>[ 3030.353181]                Type of service:    0x00<br>[ 3030.353182]            Total Length(Bytes):    0x2800 (10240)<br>[ 3030.353183]                 Identification:    0xe324 (58148)<br>[ 3030.353184]                Fragment Offset:    0x0000 (0)<br>[ 3030.353185]                   Time to live:    0x40<br>[ 3030.353186]                       Protocol:    0x06 [TCP]<br>[ 3030.353187]          Header Checksum (CRC):    0x6203<br>[ 3030.353188]              Source IP Address:    115:239:210:141<br>[ 3030.353190]         Destination IP Address:    127:0:0:1<br>[ 3030.353785] ***********IP Header***********<br>[ 3030.353787]                        Version:    0x04<br>[ 3030.353788]           Header Length(Bytes):    0x05 (5)<br>[ 3030.353788]                Type of service:    0x00<br>[ 3030.353790]            Total Length(Bytes):    0x2800 (10240)<br>[ 3030.353790]                 Identification:    0xe424 (58404)<br>[ 3030.353791]                Fragment Offset:    0x0000 (0)<br>[ 3030.353792]                   Time to live:    0x40<br>[ 3030.353793]                       Protocol:    0x06 [TCP]<br>[ 3030.353794]          Header Checksum (CRC):    0x6103<br>[ 3030.353795]              Source IP Address:    115:239:210:141<br>[ 3030.353797]         Destination IP Address:    127:0:0:1<br>[ 3030.354357] ***********IP Header***********<br>[ 3030.354358]                        Version:    0x04<br>[ 3030.354359]           Header Length(Bytes):    0x05 (5)<br>[ 3030.354360]                Type of service:    0x00<br>[ 3030.354361]            Total Length(Bytes):    0x2800 (10240)<br>[ 3030.354362]                 Identification:    0xe524 (58660)<br>[ 3030.354363]                Fragment Offset:    0x0000 (0)<br>[ 3030.354364]                   Time to live:    0x40<br>[ 3030.354365]                       Protocol:    0x06 [TCP]<br>[ 3030.354366]          Header Checksum (CRC):    0x6003<br>[ 3030.354367]              Source IP Address:    115:239:210:141<br>[ 3030.354368]         Destination IP Address:    127:0:0:1<br>[ 3030.682150] ***********IP Header***********<br>[ 3030.682154]                        Version:    0x04<br>[ 3030.682155]           Header Length(Bytes):    0x05 (5)<br>[ 3030.682157]                Type of service:    0x00<br>[ 3030.682158]            Total Length(Bytes):    0x2800 (10240)<br>[ 3030.682159]                 Identification:    0xe624 (58916)<br>[ 3030.682160]                Fragment Offset:    0x0000 (0)<br>[ 3030.682160]                   Time to live:    0x40<br>[ 3030.682161]                       Protocol:    0x06 [TCP]<br>[ 3030.682163]          Header Checksum (CRC):    0x5f03<br>[ 3030.682164]              Source IP Address:    115:239:210:141<br>[ 3030.682165]         Destination IP Address:    127:0:0:1<br>[ 3035.425863] ###################################################################<br><br></pre><br></div>
<p><font color="#ff0000">为什么通过netfilter截获的sk_buff结构，无法通过其next域获取到整个的sk_buff列表？</font></p>
<p>这是因为，sk_buff列表是由网络接口层(以太网层)维护的，当有新的网络包传送过来，网卡会向CPU发出中断请求，CPU执行中断服务例程，将网卡上的内容读入到每个CPU特定的sk_buff列表中，这个列表就是我们所说的sk_buff列表。</p>
<p>为了尽快地执行完中断服务例程的Top Half，一旦将sk_buff保存到队列中，就马上返回。</p>
<p>上层的网络层可以根据需要从队列中拿出sk_buff进行处理，如果是发往本机的，就交给上层协议继续处理，如果是转发的，就再处理一下TTL，然后交给以太网层转发出去。</p>
<p>对于本机发往其他机器的sk_buff，通过各层协议，最终加入到CPU的sk_buff队列，然后交给以太网层传送出去。</p>
<p>&nbsp;</p>
<p><a href="http://images.cnitblog.com/blog/580388/201401/221111388518.png"><img style="background-image: none; border-bottom: 0px; border-left: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; margin-left: auto; border-top: 0px; margin-right: auto; border-right: 0px; padding-top: 0px" title="image" border="0" alt="image" src="http://images.cnitblog.com/blog/580388/201401/221111391792.png" width="646" height="345"></a></p>
<p>通过上图可见，Netfilter处于的位置，都是在以太网层上面的，因此这时截获的sk_buff都是与队列无关，因此next域都是NULL。</p>
<p>否则的话，这应该也算是一个漏洞，因为相当于Netfilter就可以控制所有类型的sk_buff了，而不单单是它请求处理的类型。</p></body>
</html>

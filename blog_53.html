<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"></head>
<title>Linux&#x5D29;&#x6E83;&#x65F6;&#x542F;&#x52A8;&#x811A;&#x672C;&#x83B7;&#x53D6;&#x8FDB;&#x7A0B;&#x76F8;&#x5173;&#x4FE1;&#x606F;</title>
<body><p>编写test.cpp</p> <div id="codeSnippetWrapper"> <div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre><span style="color: #cc6633">#include</span> &lt;stdlib.h&gt;</pre><!--CRLF--><pre><span style="color: #cc6633">#include</span> &lt;stdio.h&gt;</pre><!--CRLF--><pre><span style="color: #cc6633">#include</span> &lt;exception&gt;</pre><!--CRLF--><pre><span style="color: #cc6633">#include</span> &lt;string.h&gt;</pre><!--CRLF--><pre><span style="color: #cc6633">#include</span> &lt;unistd.h&gt;</pre><!--CRLF--><pre>&nbsp;</pre><!--CRLF--><pre><span style="color: #0000ff">void</span> terminate_handler()</pre><!--CRLF--><pre>{</pre><!--CRLF--><pre>   <span style="color: #0000ff">char</span> cmdline[1024] = {0,};</pre><!--CRLF--><pre>   sprintf(cmdline, <span style="color: #006080">"bash term.sh %d %d"</span>, getpid(), getppid());</pre><!--CRLF--><pre>  <span style="color: #008000">// printf("executing %s\n", cmdline);</span></pre><!--CRLF--><pre>   system(cmdline);</pre><!--CRLF--><pre>}</pre><!--CRLF--><pre>&nbsp;</pre><!--CRLF--><pre><span style="color: #0000ff">int</span> main()</pre><!--CRLF--><pre>{</pre><!--CRLF--><pre>    std::set_terminate(terminate_handler);</pre><!--CRLF--><pre>    <span style="color: #008000">//abort();</span></pre><!--CRLF--><pre>    <span style="color: #0000ff">int</span> a = 10 / 0;</pre><!--CRLF--><pre>    <span style="color: #0000ff">throw</span> <span style="color: #006080">"test"</span>;</pre><!--CRLF--><pre>    <span style="color: #0000ff">return</span> 0;</pre><!--CRLF--><pre>}</pre><!--CRLF--></div></div>
<p>&nbsp;</p>
<p>Makefile</p>
<div id="codeSnippetWrapper">
<div style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet"><pre>CC= g++</pre><!--CRLF--><pre>CC_Flag= -O3</pre><!--CRLF--><pre>&nbsp;</pre><!--CRLF--><pre>test: test.cpp</pre><!--CRLF--><pre>    $(CC) $(CC_Flag) $&lt; -o $@</pre><!--CRLF--><pre>&nbsp;</pre><!--CRLF--><pre>&nbsp;</pre><!--CRLF--></div></div>
<p>term.sh</p>
<div id="codeSnippetWrapper"><pre>src_dir=/proc/$1<br>term_dir=$PWD/term<br>dst_dir=$term_dir/$1<br><br><br><span style="color: #cc6633">#if</span> [ -d $src_dir ]; then<br>#    echo source folder \<span style="color: #006080">"$src_dir\" existing<br>#fi<br><br>if ! [ -d $term_dir ]; then<br>    mkdir $term_dir<br>else<br>    rm -rf $term_dir/*<br>fi<br><br>if ! [ -d $dst_dir ]; then<br>#    echo destination folder \" $dst_dir \" doesn\'t existing<br>    mkdir $dst_dir<br>#else<br>#    echo destination folder \" $dst_dir \" existing<br>fi<br>    <br>if [ -f $src_dir/status ]; then<br>    cat $src_dir/status &gt; $dst_dir/status<br>    chmod a+w $dst_dir/status<br>fi<br><br>if [ -d $src_dir/task ]; then<br>    #ls $src_dir/task | tee | sed -e "</span>s/^/task /<span style="color: #006080">" <br>    for file in $(ls $src_dir/task)<br>    do<br>        thread_dir=$src_dir/task/$file<br>        if [ -d $thread_dir ]; then<br>            if [ -O $thread_dir/stack ]; then<br>                mkdir $dst_dir/$file<br>                sudo cat $thread_dir/stack &gt; $dst_dir/$file/stack<br>                chmod a+w $dst_dir/$file/stack<br>            else<br>                echo "</span>Invalid permissions"<br>                sudo cat $file/stack &gt; $dst_dir/{basename $file}/stack<br>            fi<br>        fi<br>    done<br>fi<br><br><br><br><br></pre></div>
<hr>

<p>接下来是测试结果</p>
<div id="codeSnippetWrapper"><pre>$ ./test<br>[sudo] password <span style="color: #0000ff">for</span> daniel: <br>已放弃</pre></div>
<p>&nbsp;</p>
<div id="codeSnippetWrapper"><pre>$ tree<br>.<br>├── Makefile<br>├── term<br>│ └── 5886<br>│ ├── 5886<br>│ │ └── stack<br>│ └── status<br>├── term.sh<br>├── test<br>└── test.cpp<br><br>3 directories, 6 files</pre></div>
<p>&nbsp;</p>
<div><pre>$ cat term/5886/5886/stack <br>[&lt;ffffffff81063c72&gt;] do_wait+0x1e2/0x240<br>[&lt;ffffffff81064cb4&gt;] SyS_wait4+0x64/0xe0<br>[&lt;ffffffff816f521d&gt;] system_call_fastpath+0x1a/0x1f<br>[&lt;ffffffffffffffff&gt;] 0xffffffffffffffff</pre></div>
<div>&nbsp;</div>
<div>&nbsp;</div>
<div id="codeSnippetWrapper"><pre>$ cat term/5886/status <br>Name: test<br>State: S (sleeping)<br>Tgid: 5886<br>Pid: 5886<br>PPid: 2205<br>TracerPid: 0<br>Uid: 1000 1000 1000 1000<br>Gid: 1000 1000 1000 1000<br>FDSize: 256<br>Groups: 4 24 27 30 46 112 118 124 1000 <br>VmPeak:  12652 kB<br>VmSize:  12652 kB<br>VmLck:  0 kB<br>VmPin:  0 kB<br>VmHWM:  1072 kB<br>VmRSS:  1072 kB<br>VmData:  272 kB<br>VmStk:  136 kB<br>VmExe:  4 kB<br>VmLib:  3960 kB<br>VmPTE:  44 kB<br>VmSwap:  0 kB<br>Threads: 1<br>SigQ: 0/30685<br>SigPnd: 0000000000000000<br>ShdPnd: 0000000000000000<br>SigBlk: 0000000000010000<br>SigIgn: 0000000000000006<br>SigCgt: 0000000000000000<br>CapInh: 0000000000000000<br>CapPrm: 0000000000000000<br>CapEff: 0000000000000000<br>CapBnd: 0000001fffffffff<br>Seccomp: 0<br>Cpus_allowed: ff<br>Cpus_allowed_list: 0-7<br>Mems_allowed: 00000000,00000001<br>Mems_allowed_list: 0<br>voluntary_ctxt_switches: 3<br>nonvoluntary_ctxt_switches: 1</pre></div>
<hr>

<p>用autotools来替换手动编写Makefile</p>
<p>&nbsp;</p>
<p>Makefile_Template.am</p>
<div id="codeSnippetWrapper"><pre>bin_PROGRAMS = XXX<br>XXX_SOURCES = YYY</pre></div>
<p>&nbsp;</p>
<p>autogen.sh</p>
<div><pre>sed -e <span style="color: #006080">"{<br>    s/XXX/$1/<br>    s/YYY/$2/<br>    }"</span> Makefile_Template.am &gt; Makefile.am<br><br>autoscan<br><br>sed -e <span style="color: #006080">"/AC_INIT/a\<br>    AM_INIT_AUTOMAKE"</span> configure.scan &gt; configure.ac</pre><pre>autoheader</pre><pre><br>aclocal<br>touch README AUTHORS NEWS ChangeLog <br>automake --add-missing --copy<br>autoconf<br>./configure<br>make</pre></div>
<div><span style="color: #ff0000">【s/YYY/$2是无法支持多个.cpp文件的，需要进一步优化】</span></div>
<div>&nbsp;</div>
<p>调用autogen.sh</p>
<div id="codeSnippetWrapper"><pre>bash autogen.sh test test.cpp</pre></div>
<div id="codeSnippetWrapper"><pre>./test</pre></div>
<p>结果与上面是一样的</p>
<hr>

<div id="codeSnippetWrapper"><pre style="border-bottom-style: none; text-align: left; padding-bottom: 0px; line-height: 12pt; border-right-style: none; background-color: #f4f4f4; margin: 0em; padding-left: 0px; width: 100%; padding-right: 0px; font-family: 'Courier New', courier, monospace; direction: ltr; border-top-style: none; color: black; font-size: 8pt; border-left-style: none; overflow: visible; padding-top: 0px" id="codeSnippet">src_dir=/proc/$1<br>timestamp=$(date +%F | tr <span style="color: #006080">"-"</span> <span style="color: #006080">"_"</span>)<br>timestamp=<span style="color: #006080">"$timestamp"</span>_<span style="color: #006080">"$(date +%T | tr "</span>:<span style="color: #006080">" "</span>_<span style="color: #006080">")"</span><br>term_dir=$PWD/$timestamp<br>dst_dir=$term_dir/$1<br><br><span style="color: #0000ff">if</span> ! [ -d $term_dir ]; then<br>    mkdir $term_dir<br><span style="color: #0000ff">else</span><br>    rm -rf $term_dir<span style="color: #008000">/*</span><br><span style="color: #008000">fi</span><br><span style="color: #008000"></span><br><span style="color: #008000">if ! [ -d $dst_dir ]; then</span><br><span style="color: #008000">    mkdir $dst_dir</span><br><span style="color: #008000">fi</span><br><span style="color: #008000">    </span><br><span style="color: #008000">if [ -f $src_dir/status ]; then</span><br><span style="color: #008000">    cat $src_dir/status &gt; $dst_dir/status</span><br><span style="color: #008000">    chmod a+w $dst_dir/status</span><br><span style="color: #008000">fi</span><br><span style="color: #008000"></span><br><span style="color: #008000">if [ -f $src_dir/maps ]; then</span><br><span style="color: #008000">    cat $src_dir/maps &gt; $dst_dir/maps</span><br><span style="color: #008000">    chmod a+w $dst_dir/maps</span><br><span style="color: #008000">fi</span><br><span style="color: #008000"></span><br><span style="color: #008000">if [ -d $src_dir/task ]; then</span><br><span style="color: #008000">    for file in $(ls $src_dir/task)</span><br><span style="color: #008000">    do</span><br><span style="color: #008000">        thread_dir=$src_dir/task/$file</span><br><span style="color: #008000">        if [ -d $thread_dir ]; then</span><br><span style="color: #008000">            if [ -O $thread_dir/stack ]; then</span><br><span style="color: #008000">                mkdir $dst_dir/$file</span><br><span style="color: #008000">                sudo cat $thread_dir/stack &gt; $dst_dir/$file/stack</span><br><span style="color: #008000">                chmod a+w $dst_dir/$file/stack</span><br><span style="color: #008000">            else</span><br><span style="color: #008000">                echo "Invalid permissions"</span><br><span style="color: #008000">                sudo cat $file/stack &gt; $dst_dir/$file/stack</span><br><span style="color: #008000">            fi</span><br><span style="color: #008000">        fi</span><br><span style="color: #008000">    done</span><br><span style="color: #008000">fi</span><br><span style="color: #008000"></span><br><span style="color: #008000">max_threads=$(cat /proc/sys/kernel/threads-max)</span><br><span style="color: #008000">cur_threads=$(grep -s '^Threads' /proc/[0-9]*/</span>status | awk <span style="color: #006080">'{ sum += $2; } END { print sum; }'</span>)<br>max_mem=$(cat /proc/meminfo | grep MemTotal | awk <span style="color: #006080">'{print $2,$3}'</span>)<br>free_mem=$(cat /proc/meminfo | grep MemFree | awk <span style="color: #006080">'{print $2,$3}'</span>)<br>vm_peak=$(cat $src_dir/status | grep VmPeak | awk <span style="color: #006080">'{print $2,$3}'</span>) <br>vm_size=$(cat $src_dir/status | grep VmPeak | awk <span style="color: #006080">'{print $2,$3}'</span>) <br><br>echo <span style="color: #006080">"System Summary:"</span> &gt; $term_dir/summary<br>echo <span style="color: #006080">"Threads:"</span><br>echo -e <span style="color: #006080">"Maximum \e[1;31m"</span> $max_threads <span style="color: #006080">"\e[0mthreads allowed!"</span> &gt;&gt; $term_dir/summary<br>echo -e <span style="color: #006080">"Currently \e[1;31m"</span> $cur_threads <span style="color: #006080">"\e[0mthreads consumed!"</span> &gt;&gt; $term_dir/summary<br>echo <span style="color: #006080">"Memory:"</span><br>echo -e <span style="color: #006080">"Total \e[1;31m"</span> $max_mem <span style="color: #006080">"\e[0mmemory in system!"</span> &gt;&gt; $term_dir/summary<br>echo -e <span style="color: #006080">"Free \e[1;31m"</span> $free_mem <span style="color: #006080">"\e[0mmemory in system!"</span> &gt;&gt; $term_dir/summary<br>echo <span style="color: #006080">"Process "</span> $1 <span style="color: #006080">"Memory:"</span><br>echo -e <span style="color: #006080">"Peak use \e[1;31m"</span> $vm_peak <span style="color: #006080">"\e[0mmemory!"</span> &gt;&gt; $term_dir/summary<br>echo -e <span style="color: #006080">"Current use \e[1;31m"</span> $vm_size <span style="color: #006080">"\e[0mmemory!"</span> &gt;&gt; $term_dir/summary<br><br>cat $term_dir/summary<br></pre><br></div></body>
</html>
